name: Deploy Glue Job

on:
  push:
    paths:
      - 'scripts/etl.py'
      - '.github/workflows/deploy.yml'

jobs:
  deploy-glue-job:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Upload ETL scripts to S3
      run: |
        echo "Uploading scripts to S3..."
        aws s3 cp scripts/etl.py s3://gule-script-github/glue-scripts/ --acl public-read
        echo "Upload complete."

    - name: Start AWS Glue job and log JobRunId
      id: start_job
      run: |
        echo "Starting Glue Job..."
        JOB_RUN_ID=$(aws glue start-job-run --job-name Yelp-job --query 'JobRunId' --output text)
        echo "JobRunId: $JOB_RUN_ID"
        echo "job_run_id=$JOB_RUN_ID" >> $GITHUB_OUTPUT

    - name: Wait for Glue job to finish
      run: |
        JOB_RUN_ID=${{ steps.start_job.outputs.job_run_id }}
        echo "Waiting for Glue Job ($JOB_RUN_ID) to finish..."

        while true; do
          STATUS=$(aws glue get-job-run --job-name Yelp-job --run-id $JOB_RUN_ID --query 'JobRun.JobRunState' --output text)
          echo "Current Status: $STATUS"
          if [[ "$STATUS" == "SUCCEEDED" ]]; then
            echo "Glue job succeeded!"
            break
          elif [[ "$STATUS" == "FAILED" || "$STATUS" == "STOPPED" || "$STATUS" == "TIMEOUT" ]]; then
            echo "Glue job failed or stopped with status: $STATUS"
            exit 1
          fi
          sleep 30
        done

    - name: Start Glue Crawler
      run: |
        echo "Starting Glue Crawler..."
        aws glue start-crawler --name new-crawler

    - name: Wait for Crawler to finish
      run: |
        echo "Waiting for Glue Crawler to finish..."
        while true; do
          STATE=$(aws glue get-crawler --name new-crawler --query 'Crawler.State' --output text)
          echo "Current Crawler State: $STATE"
          if [[ "$STATE" == "READY" ]]; then
            echo "Crawler completed successfully!"
            break
          fi
          sleep 15
        done
